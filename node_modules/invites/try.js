const ObjectId = require("mongodb").ObjectId;
const check = require("class/check.js");

module.exports = async (session, message) => {
    if (await session.set()) {
        const { invite } = message;

        if (check.invite(invite)) {
            const db = await require("class/database.js");
            const find = await db.collection("invites").findOne({ _id: invite }, { projection: { _id: 0, guild_id: 1 } });

            if (find !== null) {
                const guild_id = find.guild_id.toString();

                const result = await db.collection("guilds").aggregate([
                    { $match: { _id: ObjectId(guild_id) }  },
                    { $lookup: { from: "members", localField: "_id", foreignField: "guild_id", as: "members" } },
                    { $project: { _id: 0, owner: 0, channels: 0, membersCount: { $size: "$members" } }  }
                ]).toArray();

                if (result !== null) {
                    return {
                        status: true,
                        invite: invite,
                        guild: {
                            name: result.name,
                            icon: result.icon
                        }
                    }
                } else {
                    return {
                        status: false
                    }
                }
            } else {
                return {
                    status: false
                }
            }
        } else {
            return {
                status: false
            }
        }
    } else {
        return {
            status: false
        }
    }
}